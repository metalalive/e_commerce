name: media continuous integration
on:
  # push:
  #   branches:
  #     - 'media-dev/experiment/**'
  pull_request:
    branches:
      - 'master'
    paths:
      - '.github/workflows/media-ci.yaml'
      - 'services/media/**'


jobs:
  build-app-images:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Cache media backend base image tarball
        id: cache-media-backend-base
        uses: actions/cache/restore@v4
        with:
          path: ${{ runner.temp }}/media-backend-build0.tar
          key: ${{ runner.os }}-media-backend-base-${{ hashFiles('services/media/infra/apps.dockerfile') }}
      - name: Build media backend base image
        if: steps.cache-media-backend-base.outputs.cache-hit != 'true'
        uses: docker/build-push-action@v5
        with:
          context: services # Context is 'services' as Dockerfile is in services/media/infra
          file: services/media/infra/apps.dockerfile
          outputs: type=docker,dest=${{ runner.temp }}/media-backend-build0.tar
          tags: media-backend-base:latest
          target: final0
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Load media-backend-base image from cache
        if: steps.cache-media-backend-base.outputs.cache-hit == 'true'
        run: |
          docker load --input ${{ runner.temp }}/media-backend-build0.tar
      - name: Save media backend base image tarball to cache
        if: steps.cache-media-backend-base.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ runner.temp }}/media-backend-build0.tar
          key: ${{ runner.os }}-media-backend-base-${{ hashFiles('services/media/infra/apps.dockerfile') }}
      - name: Upload media-backend-base image artifact
        uses: actions/upload-artifact@v4
        with:
          name: media-backend-base-image
          path: ${{ runner.temp }}/media-backend-build0.tar
          retention-days: 1

      - name: Build media helper tool image
        uses: docker/build-push-action@v5
      - name: Cache media helper tool image tarball
        id: cache-media-helper-tool
        uses: actions/cache/restore@v4
        with:
          path: ${{ runner.temp }}/media-helper-tool-build0.tar
          key: ${{ runner.os }}-media-helper-tool-${{ hashFiles('services/media/infra/helpertool.dockerfile') }}
      - name: Build media helper tool image
        if: steps.cache-media-helper-tool.outputs.cache-hit != 'true'
        uses: docker/build-push-action@v5
        with:
          context: services # Context is 'services' as Dockerfile is in services/media/infra
          file: services/media/infra/helpertool.dockerfile
          outputs: type=docker,dest=${{ runner.temp }}/media-helper-tool-build0.tar
          tags: media-helper-tool:latest
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Load media-helper-tool image from cache
        if: steps.cache-media-helper-tool.outputs.cache-hit == 'true'
        run: |
          docker load --input ${{ runner.temp }}/media-helper-tool-build0.tar
      - name: Save media helper tool image tarball to cache
        if: steps.cache-media-helper-tool.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ runner.temp }}/media-helper-tool-build0.tar
          key: ${{ runner.os }}-media-helper-tool-${{ hashFiles('services/media/infra/helpertool.dockerfile') }}
      - name: Upload media-helper-tool image artifact
        uses: actions/upload-artifact@v4
        with:
          name: media-helper-tool-image
          path: ${{ runner.temp }}/media-helper-tool-build0.tar
          retention-days: 1

  # Job to run unit tests using Docker Compose
  run-unit-tests:
    needs: build-app-images # Depends on application images being built
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      # Load the built application image into the Docker daemon
      - name: Download media-backend-base image artifact
        uses: actions/download-artifact@v4
        with:
          name: media-backend-base-image
          path: ${{ runner.temp }}
      - name: Load media-backend-base docker image
        run: |
          docker load --input ${{ runner.temp }}/media-backend-build0.tar
          docker image list --all

      - name: Create test environment files
        working-directory: services/media/infra
        run: |
          echo "DB_HOST=media-test-mariadb" > ./container-test.env
          echo "MARIADB_ROOT_PASSWORD=DB_PASSWORD" >> ./container-test.env
          echo "SITEDBA_UNAME=DB_USERNAME"    >> ./container-test.env
          echo "SITEDBA_PASSWORD=DB_PASSWORD" >> ./container-test.env
          echo "DB_APP_UNAME=DB_USERNAME"    >> ./container-test.env
          echo "DB_APP_PASSWORD=DB_PASSWORD" >> ./container-test.env

      - name: Set up mock credentials for test
        working-directory: services/common/data
        run: |
            ln -s ./secrets_template.json  ./secrets.json

      - name: Run unit tests with Docker Compose
        working-directory: services/media
        # --abort-on-container-exit stops all containers if the unit test container exits
        run: |
            docker compose --file ./infra/docker-compose-utest.yml up --abort-on-container-exit
            docker logs media-utest-0

      - name: Clean up containers after unit tests
        if: always() # Ensures cleanup runs even if tests fail
        working-directory: services/media
        run: docker compose --file ./infra/docker-compose-utest.yml down --volumes

  run-integration-tests:
    needs: run-unit-tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build MariaDB extended image
        uses: docker/build-push-action@v5
        with:
          context: infra # Path to the infra folder relative to github.workspace
          file: infra/mariadb-ext.dockerfile
          outputs: type=docker
          tags: mariadb-ext:11-noble
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build RabbitMQ custom init image
        uses: docker/build-push-action@v5
        with:
          context: infra # Path to the infra folder relative to github.workspace
          file: infra/rabbitmq-custom-init.dockerfile
          outputs: type=docker
          tags: rabbitmq-custom-init:3.13-management
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Load the built application image into the Docker daemon
      - name: Download media-backend-base image artifact
        uses: actions/download-artifact@v4
        with:
          name: media-backend-base-image
          path: ${{ runner.temp }}
      - name: Download media-helper-tool image artifact
        uses: actions/download-artifact@v4
        with:
          name: media-helper-tool-image
          path: ${{ runner.temp }}
      - name: Load media application docker images
        run: |
          docker load --input ${{ runner.temp }}/media-backend-build0.tar
          docker load --input ${{ runner.temp }}/media-helper-tool-build0.tar
          docker image list --all
      
      - name: Set up rabbitMQ persistence path
        working-directory: ${{ github.workspace }}
        run: |
          mkdir -p installed/rabbitmq/data installed/rabbitmq/log
          sudo chown --recursive 999:999 installed/rabbitmq

      - name: setup env file for RabbitMQ container
        working-directory: infra
        run: |
          echo "RABBITMQ_NODENAME=mouse@inter-apps-msgq-dev" > ./dev.env
          echo "RABBITMQ_DEFAULT_USER=AMQP_BROKER_USERNAME" >> ./dev.env
          echo "RABBITMQ_DEFAULT_PASS=AMQP_BROKER_PASSWORD" >> ./dev.env
          echo "RABBIT_TEST_USER=AMQP_ANOTHER_USERNAME" >> ./dev.env
          echo "RABBIT_TEST_PASS=AMQP_ANOTHER_PASSWORD" >> ./dev.env
          echo "RABBITMQ_PID_FILE=/var/lib/rabbitmq/mnesia/ec-mq-server.pid" >> ./dev.env

      - name: Create inter-service docker network
        run: |
          docker network create  --driver bridge \
            --subnet 172.19.253.0/24  --ip-range 172.19.253.0/28 \
            --gateway 172.19.253.254  ec-intersrvs-dev-net
      - name: start RabbitMQ container for test
        working-directory: infra
        run: |
          docker run --name inter-apps-msgq-dev  --env-file ./dev.env \
              -v ${{ github.workspace }}/installed/rabbitmq/data:/var/lib/rabbitmq \
              -v ${{ github.workspace }}/installed/rabbitmq/log:/var/log/rabbitmq \
              -v ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro \
              -v ./rabbit-defs.json:/app/rabbit-defs.json:ro \
              -v ./rabbitmq-custom-init.sh:/init.sh:ro \
              --network ec-intersrvs-dev-net  rabbitmq-custom-init:3.13-management
          sleep 30
          docker logs inter-apps-msgq-dev --tail 40

      - name: Set up database persistence path
        working-directory: ${{ github.workspace }}
        run: |
          mkdir -p installed/mariadb/data installed/mariadb/log
          sudo chown --recursive 999:999 installed/mariadb

      - name: Create test environment files
        working-directory: services/media/infra
        run: |
          # container-test.env contains variables directly consumed by services (e.g., DB_HOST)
          echo "DB_HOST=media-test-mariadb" > ./container-test.env
          echo "MARIADB_ROOT_PASSWORD=DB_PASSWORD" >> ./container-test.env
          echo "SITEDBA_UNAME=DB_USERNAME"    >> ./container-test.env
          echo "SITEDBA_PASSWORD=DB_PASSWORD" >> ./container-test.env
          echo "DB_APP_UNAME=DB_USERNAME"    >> ./container-test.env
          echo "DB_APP_PASSWORD=DB_PASSWORD" >> ./container-test.env
          echo "CONTAINER_IP_RANGE=172.19.13.%" >> ./container-test.env
          echo "MIGRATE_VERSION_TAG=0.0.0" >> ./container-test.env
          echo "SKIP_TRANSCODING_TEST=1" >> ./container-test.env
          # interpolation-test.env contains variables for Docker Compose CLI and database setup
          echo "MARIADB_DATA_VOL=${{ github.workspace }}/installed/mariadb/data" > ./interpolation-test.env
          echo "MARIADB_LOG_VOL=${{ github.workspace }}/installed/mariadb/log" >> ./interpolation-test.env

      - name: Set up mock credentials for test
        working-directory: services/common/data
        run: |
            ln -s ./secrets_template.json  ./secrets.json

      - name: Run integration tests with Docker Compose
        working-directory: services/media
        run: |
            # Bring up MariaDB, schema migration, mock auth server, API server, RPC consumers, and the integration test runner
            docker compose --file ./infra/docker-compose-generic.yml \
                           --file ./infra/docker-compose-itest.yml \
                           --env-file ./infra/interpolation-test.env \
                           up --detach
            # Wait for the integration test runner container to exit
            python3 ${{ github.workspace }}/.github/docker_wait.py  --container-name media-itest-0  --target-status exited --timeout-secs 600
            docker ps --all --filter name=media-*
            docker logs media-test-mariadb --tail 40
            docker logs media-test-db-schema-upgrade --tail 50
            docker logs media-test-cert-renew
            docker logs media-itest-0
            docker logs media-test-apisrv

      - name: Clean up containers after integration tests
        if: always() # Ensures cleanup runs even if tests fail
        working-directory: services/media
        run: |
            docker compose --file ./infra/docker-compose-generic.yml \
                           --file ./infra/docker-compose-itest.yml \
                           --env-file ./infra/interpolation-test.env \
                           down --volumes
           
