name: media continuous integration
on:
  push:
    branches:
      - 'media-dev/**'
  pull_request:
    branches:
      - 'master'
    paths:
      - '.github/workflows/media-ci.yaml'
      - 'services/media/**'


# due to this long-time unresolved issue, it is safe to put tasks into one
# big job running sequentially, and give up nicely running simulteneous jobs.
# https://github.com/actions/checkout/issues/19
jobs:
  init-env-then-tests:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: init workspace for build
        working-directory: services/media
        run: |
            mkdir -p build
            mkdir -p build/h2o
      - name: download HTTP h2o source
        uses: actions/checkout@v4
        with:
            repository: h2o/h2o
            # always clone from master branch, libh2o maintainers no longer use release tags
            ref: master
            path: services/media/build/h2o
      - name: build libh2o from source
        working-directory: services/media/build/h2o
        run: |
            openssl version
            ls -lt
            mkdir -p build
            cd build
